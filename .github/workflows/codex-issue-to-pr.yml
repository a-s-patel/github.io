name: Codex - Issue to PR

on:
  issues:
    types: [labeled]

jobs:
  codex_issue_to_pr:
    if: github.event.label.name == 'codex-run'
    runs-on: ubuntu-latest

    permissions:
      contents: write
      pull-requests: write
      issues: read

    steps:
      - name: Checkout repo
        uses: actions/checkout@v5

      - name: Run Codex on the issue
        id: run_codex
        uses: openai/codex-action@v1
        with:
          openai-api-key: ${{ secrets.OPENAI_API_KEY }}
          prompt: |
            ISSUE TITLE:
            ${{ github.event.issue.title }}

            ISSUE BODY:
            ${{ github.event.issue.body }}

            ---
            Follow the repository rules in:
            .github/codex/prompts/issue_to_pr.md
          safety-strategy: drop-sudo
          sandbox: workspace-write

      - name: Validate site structure
        run: node scripts/validate-site.mjs

      - name: Create PR from changes
        uses: actions/github-script@v7
        env:
          CODEX_FINAL_MESSAGE: ${{ steps.run_codex.outputs.final-message }}
        with:
          github-token: ${{ github.token }}
          script: |
            const { execSync } = require('child_process');

            const issueNumber = context.payload.issue.number;
            const branch = `codex/issue-${issueNumber}`;

            execSync(`git config user.name "codex-bot"`);
            execSync(`git config user.email "codex-bot@users.noreply.github.com"`);

            execSync(`git checkout -b ${branch}`);

            const status = execSync(`git status --porcelain`).toString().trim();
            if (!status) {
              console.log("No file changes detected; skipping PR creation.");
              return;
            }

            execSync(`git add -A`);
            execSync(`git commit -m "POH: Issue #${issueNumber}"`);
            execSync(`git push --set-upstream origin ${branch}`);

            let finalMessage = process.env.CODEX_FINAL_MESSAGE || "";
            finalMessage = finalMessage.replace(/```/g, "`\u200b`\u200b`");

            const prBody =
              `Automated PR for Issue #${issueNumber}.\n\n` +
              `## Codex output\n\n` +
              `\`\`\`\n${finalMessage}\n\`\`\`\n`;

            const pr = await github.rest.pulls.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `POH: ${context.payload.issue.title}`,
              head: branch,
              base: "main",
              body: prBody
            });

            console.log(`PR created: ${pr.data.html_url}`);
