name: Mark Task Complete and Dispatch Next

on:
  pull_request:
    types: [closed]

permissions:
  contents: write
  issues: read
  pull-requests: read

concurrency:
  group: task-complete
  cancel-in-progress: false

jobs:
  complete_and_dispatch:
    if: github.event.pull_request.merged == true
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Extract Task ID from PR body
        id: task
        shell: bash
        run: |
          BODY="${{ github.event.pull_request.body }}"
          TASK_ID=$(echo "$BODY" | sed -n 's/^Task ID:\s*//p' | head -n 1 | tr -d '\r')
          if [ -z "$TASK_ID" ]; then
            echo "No Task ID found in PR body. Skipping mark/dispatch."
            echo "task_id=" >> $GITHUB_OUTPUT
            exit 0
          fi
          echo "task_id=$TASK_ID" >> $GITHUB_OUTPUT

      - name: Setup Node
        if: steps.task.outputs.task_id != ''
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Mark task complete in TASKS.md
        if: steps.task.outputs.task_id != ''
        env:
          TASK_ID: ${{ steps.task.outputs.task_id }}
        run: node scripts/mark-task-complete.mjs

      - name: Dispatch next task
        if: steps.task.outputs.task_id != ''
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPO: ${{ github.repository }}
        run: node scripts/dispatch-next-task.mjs
